#!/bin/sh

GOGO_SCRIPTS="$HOME/src/projets/gogo"
. "$GOGO_SCRIPTS/gogo.sh" # gogo >= 0.8

tourner()
{
	source=
dests=
	hote=`hostname | tr A-Z a-z | cut -d . -f 1`
for dest in \
	ssh://p/partage \
	ssh://b/Documents/partage \
	ssh://mdm/Documents/partage \
	ssh://partage/sauvegardes/partage
do
	case "$hote:$dest" in
			pasdfric:ssh://p/*) true ;;
			bonemine:ssh://b/*) true ;;
			muxdemux:ssh://mdm/*) true ;;
			sauvegardes:ssh://partage/*) true ;;
			*)
	dests="$dests$dest "
				continue
				;;
		esac
		source="$HOME/`echo "$dest" | cut -d / -f 4-`"
done
	case "$source" in "")
		echo "[31m# Impossible de d√©terminer qui je suis parmi la liste pr√©programm√©e.[0m" >&2
		exit 1
	;; esac

	gogo_dance
}

gogogo()
{
	local dest num=0
	
	Lance lancement: true # Une premi√®re t√¢che nomm√©e "lancement" pour que celles lanc√©es dans notre boucle puissent faire un Apres lancement~ sans message d'erreur "je suis la premi√®re de la lign√©e, donc il n'y en a aucune de ce nom".
	
	for dest in $dests
	do
		Lance joindreEtPlanifier $num "$dest"
		num=$((num + 1))
	done
}

joindreEtPlanifier()
{
	local num=$1 dest="$2" h="`echo "$2" | sed -e 's#.*://##' -e 's#/.*##'`"
	local file joignable=$(ssh -o ConnectTimeout=5 "$h" sh -c 'ps auxww | grep "[u]nison" | wc -l' | tr -d ' \t')
	case "$joignable" in
		"") return 0 ;;
		0) true ;;
		*) sleep 1 ;; # Une fa√ßon de temporiser le lancement si un unison tourne d√©j√†. En r√©alit√© on temporise l'empilement via Apr√®s, ce qui nous empilera apr√®s tous ceux d√©j√† empil√©s sous ce nom (et la seconde suppl√©mentaire laisse un peu plus de temps pour d√©tecter d'autres qui peuvent √™tre lanc√©s imm√©diatement).
	esac
	echo "$h joignable, $joignable unison tournant d√©j√† dessus"
	Apres lancement~ lancement: faire "$h" "$dest"
}

faire()
{
	local dest="$2"
	echo "Je fais $1"
	lockf -t 10 $HOME/tmp/partage.verrou $HOME/local/bin/unison -batch -backups -maxbackups 3 $source $dest
}

case `uname` in
	Linux)
		lockf()
		{
			case "$1" in -t) shift ; set -- -w "$@" ;; esac
			flock "$@"
		}
		;;
esac

tourner "$@"
